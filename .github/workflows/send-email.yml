name: Notify Blog Comment

on:
  discussion_comment:
    types: [created]

jobs:
  notify:
    runs-on: ubuntu-latest
    # å¿…é¡»å¢åŠ æƒé™æ‰èƒ½è¯»å–è®¨è®ºå†…å®¹ï¼Œè¿™æ˜¯ API è°ƒç”¨æ‰€å¿…éœ€çš„
    permissions:
      discussions: read
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Convert to Beijing Time
        id: time
        run: |
          # è½¬æ¢ UTC æ—¶é—´ä¸ºåŒ—äº¬æ—¶é—´ (UTC + 8 å°æ—¶)
          UTC_TIME="${{ github.event.comment.created_at }}"
          BJ_TIME=$(date -d "$UTC_TIME 8 hour" "+%Y-%m-%d %H:%M:%S")
          echo "bj=$BJ_TIME" >> $GITHUB_OUTPUT

      # âœ… æ•´åˆæ­¥éª¤ï¼šå¤„ç†å½“å‰è¯„è®ºã€åˆ¤æ–­å›å¤çŠ¶æ€ã€è·å–çˆ¶è¯„è®ºæ•°æ®
      - name: Prepare All Comment Data
        id: data
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PARENT_ID: ${{ github.event.comment.parent_id }}
        run: |
          # 1. å¤„ç†å½“å‰è¯„è®ºå†…å®¹ (è½¬ä¹‰å’Œæ¢è¡Œç¬¦)
          COMMENT_BODY=$(echo '${{ github.event.comment.body }}' | awk '{gsub("\n", "<br>"); print}' | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g')
          
          # 2. åˆå§‹åŒ–é»˜è®¤å€¼ï¼ˆéå›å¤æƒ…å†µï¼‰
          STATUS_TEXT="æ–°çš„è¯„è®º"
          REPLY_TO_USER_OUT=""
          REPLY_TO_BODY_OUT=""

          # 3. å¦‚æœæ˜¯å›å¤ï¼Œä½¿ç”¨ curl è·å–çˆ¶è¯„è®ºå†…å®¹
          if [ -n "$PARENT_ID" ]; then
              STATUS_TEXT="æ–°çš„å›å¤"
              
              # ğŸ”¥ ä¿®å¤ï¼šä½¿ç”¨ curl è°ƒç”¨ GitHub GraphQL API æ¥æŸ¥è¯¢ Node ID (PARENT_ID)
              QUERY='{"query": "query($id: ID!) { node(id: $id) { ... on DiscussionComment { author { login } body } } }", "variables": {"id": "'$PARENT_ID'"}}'

              RESPONSE=$(curl -s \
                -X POST \
                -H "Authorization: Bearer $GH_TOKEN" \
                -H "Content-Type: application/json" \
                -d "$QUERY" \
                "https://api.github.com/graphql")

              # æå–å­—æ®µ (æ³¨æ„ï¼šGraphQL ç»“æ„ä¸ REST ä¸åŒ)
              REPLY_TO_USER_OUT=$(echo "$RESPONSE" | jq -r '.data.node.author.login')
              RAW_BODY=$(echo "$RESPONSE" | jq -r '.data.node.body')
              
              # æ£€æŸ¥æ˜¯å¦æˆåŠŸè·å–æ•°æ®
              if [ "$REPLY_TO_USER_OUT" = "null" ] || [ -z "$REPLY_TO_USER_OUT" ]; then
                  # å¦‚æœè·å–å¤±è´¥ï¼ˆé€šå¸¸æ˜¯æƒé™æˆ– API é—®é¢˜ï¼‰ï¼Œä¿ç•™ç©ºå€¼
                  REPLY_TO_USER_OUT=""
                  REPLY_TO_BODY_OUT=""
              else
                  # æˆåŠŸè·å–ï¼Œè½¬ä¹‰çˆ¶è¯„è®ºå†…å®¹ (æ›¿æ¢æ¢è¡Œç¬¦ä¸º <br>)
                  REPLY_TO_BODY_OUT=$(echo "$RAW_BODY" | awk '{gsub("\n", "<br>"); print}' | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g')
              fi
          fi
          
          # 4. å¯¼å‡ºæ‰€æœ‰å˜é‡ (ç¡®ä¿æ‰€æœ‰å˜é‡åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½è¢«å®šä¹‰)
          echo "comment_body=$COMMENT_BODY" >> $GITHUB_OUTPUT
          echo "reply_status=$STATUS_TEXT" >> $GITHUB_OUTPUT
          echo "reply_to_user=$REPLY_TO_USER_OUT" >> $GITHUB_OUTPUT
          echo "reply_to_body=$REPLY_TO_BODY_OUT" >> $GITHUB_OUTPUT
          
          # æ„é€  HTML éšè—é€»è¾‘æ‰€éœ€çš„å˜é‡
          if [ -z "$REPLY_TO_BODY_OUT" ]; then
             # éå›å¤æ—¶ï¼Œä½¿ç”¨ style="display: none;" éšè—æ•´ä¸ªåŒºå—
             DISPLAY_STYLE_OUT='display: none;'
             MARGIN_HEIGHT_OUT='20px' # éå›å¤æ—¶ï¼Œéœ€è¦ 20px é—´è·
          else
             # å›å¤æ—¶ï¼Œæ­£å¸¸æ˜¾ç¤º
             DISPLAY_STYLE_OUT=''
             MARGIN_HEIGHT_OUT='0px' # å›å¤æ—¶ï¼Œä¸éœ€è¦é¢å¤–çš„ 20px é—´è·
          fi

          echo "reply_display_style=$DISPLAY_STYLE_OUT" >> $GITHUB_OUTPUT
          echo "margin_height=$MARGIN_HEIGHT_OUT" >> $GITHUB_OUTPUT


      - name: Prepare email HTML
        run: |
          cp $GITHUB_WORKSPACE/template.html email.html
          
          # æ›¿æ¢æ—¶é—´ã€å½“å‰è¯„è®ºå’Œå…ƒæ•°æ®
          sed -i "s|{{BJ_TIME}}|${{ steps.time.outputs.bj }}|g" email.html
          sed -i "s|{{COMMENT_BODY}}|${{ steps.data.outputs.comment_body }}|g" email.html
          sed -i "s|{{COMMENT_USER}}|${{ github.event.comment.user.login }}|g" email.html
          sed -i "s|{{DISCUSSION_URL}}|${{ github.event.comment.html_url }}|g" email.html
          sed -i "s|{{BLOG_URL}}|${{ secrets.BLOG_BASE_URL }}${{ github.event.discussion.title }}|g" email.html
          sed -i "s|{{COMMENT_USER_TYPE}}|${{ github.event.comment.user.type }}|g" email.html
          sed -i "s|{{USER_URL}}|${{ github.event.comment.user.html_url }}|g" email.html
          sed -i "s|{{USER_AVATAR}}|${{ github.event.comment.user.avatar_url }}|g" email.html
          
          # æ›¿æ¢å›å¤ç›¸å…³å ä½ç¬¦
          # IS_REPLY (å¸ƒå°”å€¼)
          sed -i "s|{{IS_REPLY}}|${{ github.event.comment.parent_id }}|g" email.html 
          # REPLY_STATUS (çŠ¶æ€æ–‡æœ¬)
          sed -i "s|{{REPLY_STATUS}}|${{ steps.data.outputs.reply_status }}|g" email.html
          # REPLY_TO_USER/BODY (ä» API è·å–æˆ–ä¸ºç©º)
          sed -i "s|{{REPLY_TO_USER}}|${{ steps.data.outputs.reply_to_user }}|g" email.html
          sed -i "s|{{REPLY_TO_BODY}}|${{ steps.data.outputs.reply_to_body }}|g" email.html
          
          # æ›¿æ¢ HTML éšè—é€»è¾‘
          sed -i "s|{{REPLY_DISPLAY_STYLE}}|${{ steps.data.outputs.reply_display_style }}|g" email.html
          sed -i "s|{{MARGIN_HEIGHT}}|${{ steps.data.outputs.margin_height }}|g" email.html


      - name: Send email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "åšå®¢æœ‰æ–°è¯„è®ºï¼"
          to: "2396768163@qq.com"
          from: "Giscus <${{ secrets.MAIL_USERNAME }}>"
          html_body: file://email.html
