name: Notify Blog Comment

on:
  discussion_comment:
    types: [created]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Convert UTC to Beijing Time
        id: time
        run: |
          UTC_TIME="${{ github.event.comment.created_at }}"
          BJ_TIME=$(date -d "$UTC_TIME 8 hour" "+%Y-%m-%d %H:%M:%S")
          echo "bj=$BJ_TIME" >> $GITHUB_OUTPUT

      - name: Escape HTML characters for comment
        id: escape
        run: |
          COMMENT_BODY=$(echo '${{ github.event.comment.body }}' | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g')
          echo "comment_body=$COMMENT_BODY" >> $GITHUB_OUTPUT

      # ğŸ”¥ è·å–çˆ¶è¯„è®ºå†…å®¹ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      - name: Fetch parent comment if reply
        id: parent
        if: ${{ github.event.comment.parent_id != null }}
        run: |
          RESPONSE=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repositories/${{ github.event.repository.id }}/discussions/${{ github.event.discussion.number }}/comments/${{ github.event.comment.parent_id }}")

          # æå–å­—æ®µ
          PARENT_BODY=$(echo "$RESPONSE" | jq -r '.body')
          PARENT_USER=$(echo "$RESPONSE" | jq -r '.user.login')

          # è½¬ä¹‰ HTML
          PARENT_BODY_ESCAPED=$(echo "$PARENT_BODY" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g')

          echo "body=$PARENT_BODY_ESCAPED" >> $GITHUB_OUTPUT
          echo "user=$PARENT_USER" >> $GITHUB_OUTPUT

      - name: Prepare email HTML
        run: |
          cp $GITHUB_WORKSPACE/template.html email.html

          sed -i "s|{{BJ_TIME}}|${{ steps.time.outputs.bj }}|g" email.html
          sed -i "s|{{COMMENT_BODY}}|${{ steps.escape.outputs.comment_body }}|g" email.html
          sed -i "s|{{COMMENT_USER}}|${{ github.event.comment.user.login }}|g" email.html
          sed -i "s|{{DISCUSSION_URL}}|${{ github.event.comment.html_url }}|g" email.html
          sed -i "s|{{BLOG_URL}}|${{ secrets.BLOG_BASE_URL }}${{ github.event.discussion.title }}|g" email.html
          sed -i "s|{{COMMENT_USER_TYPE}}|${{ github.event.comment.user.type }}|g" email.html
          sed -i "s|{{USER_URL}}|${{ github.event.comment.user.html_url }}|g" email.html
          sed -i "s|{{USER_AVATAR}}|${{ github.event.comment.user.avatar_url }}|g" email.html

          # æ˜¯å¦ä¸ºå›å¤ï¼ˆtrue / falseï¼‰
          sed -i "s|{{IS_REPLY}}|${{ github.event.comment.parent_id != null }}|g" email.html

          # æ’å…¥çˆ¶è¯„è®ºå†…å®¹ï¼ˆä¸ºç©ºåˆ™ä¸æ›¿æ¢ï¼‰
          sed -i "s|{{REPLY_TO_USER}}|${{ steps.parent.outputs.user }}|g" email.html
          sed -i "s|{{REPLY_TO_BODY}}|${{ steps.parent.outputs.body }}|g" email.html

      - name: Send email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "åšå®¢æœ‰æ–°è¯„è®ºï¼"
          to: "2396768163@qq.com"
          from: "Giscus <${{ secrets.MAIL_USERNAME }}>"
          html_body: file://email.html
