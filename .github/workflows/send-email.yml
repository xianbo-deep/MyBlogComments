name: Notify Blog Comment

on:
  discussion_comment:
    types: [created]

jobs:
  notify:
    runs-on: ubuntu-latest
    # 必须增加权限才能读取讨论内容，这是 API 调用所必需的
    permissions:
      discussions: read
      contents: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Convert to Beijing Time
        id: time
        run: |
          # 转换 UTC 时间为北京时间 (UTC + 8 小时)
          UTC_TIME="${{ github.event.comment.created_at }}"
          BJ_TIME=$(date -d "$UTC_TIME 8 hour" "+%Y-%m-%d %H:%M:%S")
          echo "bj=$BJ_TIME" >> $GITHUB_OUTPUT

      # ✅ 整合步骤：处理当前评论、判断回复状态、获取父评论数据
      - name: Prepare All Comment Data
        id: data
        env:
          # 注意：GitHub Token 需要加上 "token " 前缀
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PARENT_ID: ${{ github.event.comment.parent_id }}
          REPOSITORY_ID: ${{ github.event.repository.id }}
          DISCUSSION_NUMBER: ${{ github.event.discussion.number }}
        run: |
          # 1. 处理当前评论内容 (转义和换行符)
          COMMENT_BODY=$(echo '${{ github.event.comment.body }}' | awk '{gsub("\n", "<br>"); print}' | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g')
          
          # 2. 初始化默认值（非回复情况）
          STATUS_TEXT="否 (新评论)"
          REPLY_TO_USER_OUT=""
          REPLY_TO_BODY_OUT=""

          # 3. 如果是回复，使用 curl 获取父评论内容
          if [ -n "$PARENT_ID" ]; then
              STATUS_TEXT="是 (回复)"
              
              # 使用 curl 调用 GitHub REST API (使用用户提供的结构)
              RESPONSE=$(curl -s \
                -H "Authorization: Bearer $GH_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repositories/$REPOSITORY_ID/discussions/$DISCUSSION_NUMBER/comments/$PARENT_ID")

              # 提取字段
              REPLY_TO_USER_OUT=$(echo "$RESPONSE" | jq -r '.user.login')
              RAW_BODY=$(echo "$RESPONSE" | jq -r '.body')
              
              # 转义父评论内容 (替换换行符为 <br>)
              REPLY_TO_BODY_OUT=$(echo "$RAW_BODY" | awk '{gsub("\n", "<br>"); print}' | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g')
          fi
          
          # 4. 导出所有变量 (确保所有变量在任何情况下都被定义)
          echo "comment_body=$COMMENT_BODY" >> $GITHUB_OUTPUT
          echo "reply_status=$STATUS_TEXT" >> $GITHUB_OUTPUT
          echo "reply_to_user=$REPLY_TO_USER_OUT" >> $GITHUB_OUTPUT
          echo "reply_to_body=$REPLY_TO_BODY_OUT" >> $GITHUB_OUTPUT
          
          # 构造一个用于 HTML 隐藏的变量
          if [ -z "$REPLY_TO_BODY_OUT" ]; then
             # 非回复时，使用 style="display: none;" 隐藏整个区块
             DISPLAY_STYLE_OUT='display: none;'
             MARGIN_HEIGHT_OUT='20px' # 非回复时，需要 20px 间距
          else
             # 回复时，正常显示
             DISPLAY_STYLE_OUT=''
             MARGIN_HEIGHT_OUT='0px' # 回复时，不需要额外的 20px 间距
          fi

          echo "reply_display_style=$DISPLAY_STYLE_OUT" >> $GITHUB_OUTPUT
          echo "margin_height=$MARGIN_HEIGHT_OUT" >> $GITHUB_OUTPUT


      - name: Prepare email HTML
        run: |
          cp $GITHUB_WORKSPACE/template.html email.html
          
          # 替换时间、当前评论和元数据
          sed -i "s|{{BJ_TIME}}|${{ steps.time.outputs.bj }}|g" email.html
          sed -i "s|{{COMMENT_BODY}}|${{ steps.data.outputs.comment_body }}|g" email.html
          sed -i "s|{{COMMENT_USER}}|${{ github.event.comment.user.login }}|g" email.html
          sed -i "s|{{DISCUSSION_URL}}|${{ github.event.comment.html_url }}|g" email.html
          sed -i "s|{{BLOG_URL}}|${{ secrets.BLOG_BASE_URL }}${{ github.event.discussion.title }}|g" email.html
          sed -i "s|{{COMMENT_USER_TYPE}}|${{ github.event.comment.user.type }}|g" email.html
          sed -i "s|{{USER_URL}}|${{ github.event.comment.user.html_url }}|g" email.html
          sed -i "s|{{USER_AVATAR}}|${{ github.event.comment.user.avatar_url }}|g" email.html
          
          # 替换回复相关占位符
          # IS_REPLY (布尔值)
          sed -i "s|{{IS_REPLY}}|${{ github.event.comment.parent_id }}|g" email.html 
          # REPLY_STATUS (状态文本)
          sed -i "s|{{REPLY_STATUS}}|${{ steps.data.outputs.reply_status }}|g" email.html
          # REPLY_TO_USER/BODY (从 API 获取或为空)
          sed -i "s|{{REPLY_TO_USER}}|${{ steps.data.outputs.reply_to_user }}|g" email.html
          sed -i "s|{{REPLY_TO_BODY}}|${{ steps.data.outputs.reply_to_body }}|g" email.html
          
          # 替换 HTML 隐藏逻辑
          sed -i "s|{{REPLY_DISPLAY_STYLE}}|${{ steps.data.outputs.reply_display_style }}|g" email.html
          sed -i "s|{{MARGIN_HEIGHT}}|${{ steps.data.outputs.margin_height }}|g" email.html


      - name: Send email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.qq.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "博客有新评论！"
          to: "2396768163@qq.com"
          from: "Giscus <${{ secrets.MAIL_USERNAME }}>"
          html_body: file://email.html
